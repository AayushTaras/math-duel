<!DOCTYPE html>
<html>
<head>
    <title>Math Duel | Live</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>

    <style>
        :root { --bg: #0b0e14; --card: #1e1f2b; --accent: #4e7cfe; --text: #e3e3e3; --success: #00f097; --error: #ff4e4e; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: var(--card); padding: 2.5rem; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; max-width: 450px; text-align: center; }
        h1 { color: var(--accent); letter-spacing: 2px; }
        #math-problem { background: rgba(255,255,255,0.03); padding: 25px; border-radius: 16px; margin: 20px 0; min-height: 60px; font-size: 1.5rem; }
        input { background: #2a2c3d; border: 1px solid #444; padding: 12px; border-radius: 12px; color: white; width: 80%; margin-bottom: 10px; text-align: center; font-size: 1rem; }
        button { background: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #444; }
        .history-item { background: rgba(255,255,255,0.05); margin: 8px 0; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="container">
        <h1>MATH DUEL</h1>
        
        <div id="setup">
            <button onclick="socket.emit('create_game')">Create Match</button>
            <p style="color: #666;">OR</p>
            <input type="text" id="codeField" placeholder="Enter Code">
            <button onclick="socket.emit('join_game', document.getElementById('codeField').value.toUpperCase())">Join Duel</button>
            <h3 id="status" style="margin-top: 20px; color: var(--accent);"></h3>
        </div>

        <div id="game-area" style="display:none;">
            <p id="round-info" style="font-size: 0.8rem; color: #888;"></p>
            <div id="math-problem"></div>
            <input type="text" id="answerField" placeholder="Type answer (e.g. 1/2 * x^2)">
            <button id="submitBtn" onclick="checkAnswer()">Submit</button>
            <p id="feedback" style="margin-top: 15px; font-weight: bold;"></p>
        </div>
    </div>

    <script> src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentCorrectAnswer = "";

        socket.on('game_created', id => {
            document.getElementById('status').innerText = "Game Code: " + id;
        });

        socket.on('start_round', data => {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game-area').style.display = 'block';
            document.getElementById('answerField').value = "";
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('feedback').innerText = "";

            currentCorrectAnswer = data.problem.a;
            const ids = Object.keys(data.scores);
            const scoreDisp = ids.length > 1 ? `${data.scores[ids[0]]} - ${data.scores[ids[1]]}` : "Waiting...";
            document.getElementById('round-info').innerText = `ROUND ${data.roundNumber}/5 | SCORE: ${scoreDisp}`;
            
            katex.render(data.problem.q, document.getElementById('math-problem'));
        });
       
        function createMatch() {
    // 1. Get the room name the user typed
    const roomName = document.getElementById('roomInput').value.trim();

    // 2. Validate it
    if (!roomName) {
        alert("Please enter a Room Name first!");
        return;
    }

    // 3. Set the global variable so we know where we are
    myRoom = roomName;

    // 4. Tell the server we are joining/creating this room
    // Note: We use 'join_room' because our server treats them the same
    socket.emit('join_room', roomName);

    // 5. VISUAL CHANGE: Hide Start Screen, Show Game Screen
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
}
        
function checkAnswer() {
    const inputField = document.getElementById('answerField');
    const feedback = document.getElementById('feedback');
    let userAns = inputField.value.trim().toLowerCase();
    let correct = currentCorrectAnswer.trim().toLowerCase();

    // 1. GATEKEEPER: Prevent points for empty clicks
    if (!userAns) {
        feedback.innerText = "Type something first!";
        feedback.style.color = "orange";
        return;
    }

    // 2. NORMALIZATION: Fix mobile dashes and standardize notation
    // Converts long dashes to standard hyphens
    userAns = userAns.replace(/[\u2012\u2013\u2014\u2212]/g, '-');
    correct = correct.replace(/[\u2012\u2013\u2014\u2212]/g, '-');

    // Bridge the gap between user 'ln' and server 'log'
    userAns = userAns.replace(/ln/g, 'log');
    // Bridge the gap between user 'e^' and server 'exp'
    userAns = userAns.replace(/e\^/g, 'exp');

    // 3. FUZZY TEXT MATCH: Ignore formatting "noise"
    // Strips spaces, stars, and parentheses for a strict symbol check
    const cleanUser = userAns.replace(/[\s\*\(\)]/g, '');
    const cleanCorrect = correct.replace(/[\s\*\(\)]/g, '');
    
    if (cleanUser === cleanCorrect) {
        return solveSuccess();
    }

    // 4. SMART MATH EVALUATION: Handles fractions vs decimals
    t// 4. SMART MATH EVALUATION
try {
    // We test at two points. For definite integrals (numbers), 
    // val1 and val2 will be the same. For functions (x), they will differ.
    const points = [1.5, 2.5]; 
    const isMatch = points.every(val => {
        const scope = { x: val };
        
        // math.evaluate returns a number for both "0.5" and "0.5*x" (when x is provided)
        const u = math.evaluate(userAns, scope);
        const c = math.evaluate(correct, scope);
        
        // Use a small tolerance for decimal/fraction comparison
        return Math.abs(u - c) < 0.02; 
    });

    if (isMatch) return solveSuccess();
} catch (e) {
    // If userAns is incomplete (e.g., "5*"), evaluate might throw an error.
    // We catch it here so the game doesn't break.
    console.log("Waiting for complete formula...");
}
    // 5. FAILURE FEEDBACK
    feedback.innerText = "Wrong Answer";
    feedback.style.color = "#ff4e4e";
}

function solveSuccess() {
    const feedback = document.getElementById('feedback');
    feedback.innerText = "✓ Correct!";
    feedback.style.color = "#00f097";
    document.getElementById('submitBtn').disabled = true;
    socket.emit('i_solved_it');
}

    function solveSuccess() {
        const feedback = document.getElementById('feedback');
        feedback.innerText = "✓ Correct!";
        feedback.style.color = "#00f097";
        document.getElementById('submitBtn').disabled = true;
        socket.emit('i_solved_it');
    }

function solveSuccess() {
    const feedback = document.getElementById('feedback');
    feedback.innerText = "✓ Correct!";
    feedback.style.color = "var(--success)";
    document.getElementById('submitBtn').disabled = true;
    socket.emit('i_solved_it');
}
function solveSuccess() {
    const feedback = document.getElementById('feedback');
    feedback.innerText = "✓ Correct!";
    feedback.style.color = "var(--success)";
    document.getElementById('submitBtn').disabled = true;
    socket.emit('i_solved_it');
}

        function solveSuccess() {
            document.getElementById('feedback').innerText = "✓ Correct!";
            document.getElementById('feedback').style.color = "var(--success)";
            document.getElementById('submitBtn').disabled = true;
            socket.emit('i_solved_it');
        }

        socket.on('final_results', data => {
            let history = "<h3>Results</h3>";
            data.history.forEach((winner, i) => {
                const result = winner === socket.id ? "WIN" : "LOSS";
                history += `<div class="history-item"><span>Round ${i+1}</span><span>${result}</span></div>`;
            });
            document.querySelector('.container').innerHTML = `<h1>GAME OVER</h1>${history}<button onclick="location.reload()">Play Again</button>`;
        });
    </script>
</body>
</html>













