<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/dist/mathjax.js?config=TeX-MML-AM_CHTML"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Duel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        .container {
            background-color: #16213e;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            width: 350px;
        }
        input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            width: 70%;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            background-color: #0f3460;
            color: white;
            font-weight: bold;
            transition: 0.3s;
            margin: 5px;
        }
        button:hover { background-color: #e94560; }
        
        #game-screen { display: none; }
        
        .problem-box {
            font-size: 2rem;
            margin: 20px 0;
            padding: 20px;
            background: #0f3460;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
        }
        #feedback { height: 20px; font-size: 0.9rem; margin-top: 10px; }
        .score-board { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.8rem; color: #aaa; }
    </style>
</head>
<body>

    <div class="container">
        <div id="start-screen">
            <h1>MATH DUEL</h1>
            <input type="text" id="roomInput" placeholder="Enter Room Code (e.g. A1B2)">
            <br>
            <button onclick="createMatch()">Create Match</button>
            <button onclick="joinMatch()">Join Match</button>
        </div>

        <div id="game-screen">
            <div class="score-board">
                <span id="room-display">Room: --</span>
                <span id="score-display">Score: 0</span>
            </div>
            
            <div class="problem-box" id="problem">Waiting...</div>
            
            <input type="text" id="answerField" placeholder="Enter integral..." autocomplete="off">
            <br>
            <button id="submitBtn" onclick="checkAnswer()">Submit</button>
            
            <div id="feedback"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let myRoom = "";
        let currentCorrectAnswer = "";

        // --- MATCHMAKING LOGIC ---

        function createMatch() {
            // Tell server to make a room
            socket.emit('create_game');
        }

        // LISTEN: Server sends back the new Room ID
        socket.on('game_created', (roomID) => {
            myRoom = roomID;
            
            // Show the code to the user
            alert("Match Created! Your Room Code is: " + roomID + "\nShare this with your friend!");
            
            // Switch UI
            enterGameUI(roomID);
        });

        function joinMatch() {
            const code = document.getElementById('roomInput').value.trim().toUpperCase();
            if (code) {
                myRoom = code;
                socket.emit('join_game', code);
                enterGameUI(code);
            } else {
                alert("Please enter a room code first.");
            }
        }

        function enterGameUI(roomID) {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('room-display').innerText = "Room: " + roomID;
        }

        // --- GAMEPLAY LOGIC ---

      socket.on('new_round', (data) => {
    // 1. Wrap the question in MathJax delimiters \( and \)
    // Note the double backslashes needed for JS strings
    document.getElementById('problem').innerHTML = `\\( ${data.question} \\)`;
    
    currentCorrectAnswer = data.answer;
    
    // Reset UI
    document.getElementById('answerField').value = "";
    document.getElementById('answerField').disabled = false;
    document.getElementById('answerField').focus();
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('feedback').innerText = "";

    // 2. TELL MATHJAX TO RENDER THE NEW TEXT
    if (window.MathJax) {
        MathJax.typesetPromise();
    }
});
        socket.on('update_scores', (scores) => {
            // Simple logic: show MY score. 
            const myScore = scores[socket.id] || 0;
            document.getElementById('score-display').innerText = "Score: " + myScore;
        });

        // --- THE MATH CHECKER ---

        function checkAnswer() {
            const inputField = document.getElementById('answerField');
            const feedback = document.getElementById('feedback');
            let userAns = inputField.value.trim().toLowerCase();
            let correct = currentCorrectAnswer.trim().toLowerCase();

            if (!userAns) return;

            // 1. NORMALIZE SYMBOLS
            userAns = userAns.replace(/[\u2012\u2013\u2014\u2212]/g, '-'); // Fix dashes
            correct = correct.replace(/[\u2012\u2013\u2014\u2212]/g, '-');
            
            // Bridge formats
            userAns = userAns.replace(/e\^/g, 'exp').replace(/ln/g, 'log');

            // 2. FUZZY TEXT MATCH (Strips spaces, stars, brackets)
            // Allows (1/3)x^3 to match 1/3x^3
            const cleanUser = userAns.replace(/[\s\*\(\)]/g, '');
            const cleanCorrect = correct.replace(/[\s\*\(\)]/g, '');

            if (cleanUser === cleanCorrect) {
                return solveSuccess();
            }

            // 3. ROBUST MATH EVALUATION
            try {
                // Check at two points to prevent false positives
                // Works for both Functions (integrals) and Numbers (definite integrals)
                const points = [1.5, 2.5]; 
                const isMatch = points.every(val => {
                    const scope = { x: val };
                    const uVal = math.evaluate(userAns, scope);
                    const cVal = math.evaluate(correct, scope);
                    // 0.02 tolerance allows for 1/3 vs 0.333 differences
                    return Math.abs(uVal - cVal) < 0.02; 
                });

                if (isMatch) return solveSuccess();

            } catch (e) {
                console.log("Math parsing error (incomplete formula?)");
            }

            // Failure
            feedback.innerText = "Wrong Answer";
            feedback.style.color = "#ff4e4e";
            
            // Shake effect
            inputField.style.border = "2px solid red";
            setTimeout(() => inputField.style.border = "none", 500);
        }

        function solveSuccess() {
            const feedback = document.getElementById('feedback');
            feedback.innerText = "âœ“ Correct!";
            feedback.style.color = "#00f097";
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('answerField').disabled = true;
            
            // Tell server we won this round
            socket.emit('i_solved_it', myRoom);
        }

        // Allow pressing "Enter" to submit
        document.getElementById("answerField").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                checkAnswer();
            }
        });
    </script>
</body>
</html>


